<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Generate Link</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
      <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">
      <style>
         .invite-generator {
         max-width: 520px;
         background: #ffffff;
         border-radius: 20px;
         box-shadow: 0 12px 32px rgba(0,0,0,.08);
         }
         .invite-generator textarea {
         resize: none;
         }
         .btn-wa {
         background-color: #25D366;
         color: #fff;
         }
         .btn-wa:hover {
         background-color: #1ebe5d;
         }
         .btn-report {
         background-color: #f4860a;
         color: #fff;
         }
         .btn-report:hover {
         background-color: #c3983c;
         }
      </style>
   </head>
   <body>
      <div class="container py-4">
         <h2 class="text-center">ðŸ’Œ Bagikan Undangan</h2>
         <p class="desc text-center">Isi nama tamu dan pilih template pesan untuk mengirim undangan via WhatsApp.</p>
         <div class="mb-3">
            <label class="form-label">URL link<span class="small text-danger"> (*Isian default url undangan web)</span></label>            
            <input class="form-control" type="text" id="UrlLink" readonly/>
         </div>
         <div class="mb-3">
            <label class="form-label">Nama Tamu<span class="small text-danger"> (*Nama tamu tidak boleh menggunakan spesial karakter selain &, dan tidak boleh menggunakan icon.)</span></label>
            <input class="form-control" type="text" id="guestName" placeholder="Contoh: Bapak Andi" />
         </div>
         <div class="mb-3">
            <label class="form-label">Pilih Template Pesan</label>
            <select id="messageTemplate" class="form-select">
               <option value="">-- Pilih Template --</option>
               <option value="caption1">Caption 1</option>
               <option value="caption2">Caption 2</option>
               <option value="caption3">Caption 3</option>
               <option value="caption4">Caption 4</option>
               <option value="caption5">Caption 5</option>
            </select>
         </div>
         <div class="mb-3">
            <label class="form-label">Preview Pesan</label>
            <textarea id="messagePreview" class="form-control" rows="5"></textarea>
         </div>
         <div class="d-grid gap-2">
            <button id="copyBtn" class="btn btn-primary">ðŸ“‹ Copy Pesan</button>
            <button id="waBtn" class="btn btn-wa">ðŸ’¬ Kirim via WhatsApp</button>
            <button id="btnDownloadRsvp" class="btn btn-report">ðŸ“¥ Download Rsvp</button>
         </div>
         <p class="text-center small mt-3 text-danger">
            *Tombol Copy Caption pesan, berguna untuk kirim pesan non-whatsapp (via chat IG/FB/Email/dan lainnya)<br>
            *WhatsApp akan terbuka otomatis, Anda tinggal memilih kontak
         </p>
      </div>
      </div>
      <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
      <script>

         const origin = window.location.origin;
         const path = window.location.pathname.split('/').filter(Boolean);
         const coupleSlug = path[0] || 'janewithnama';
         
         const slug = path[0];

         // hasil final
         const coupleUrl = `${origin}/${slug}`;

         // Pisahkan berdasarkan kata 'with'
         const parts = coupleSlug.split('with');
         const bride = parts[0] ? parts[0].charAt(0).toUpperCase() + parts[0].slice(1) : '';
         const groom = parts[1] ? parts[1].charAt(0).toUpperCase() + parts[1].slice(1) : '';
         
         
         const coupleName = `${bride} & ${groom}`;
         
         $('#UrlLink').val(coupleUrl);
         
         console.log('Bride:', bride);
         console.log('Groom:', groom);(/-/g, ' ').toUpperCase();
         
         
         const templates = {
            caption1:
`Assalamualaikum warahmatullahi wabarakatuh. Bismillahirahmanirrahim.

Mahasuci Allah telah menciptakan manusia dengan berpasang-pasangan. Sungguh besar rahmat dan karunia yang diberikan-Nya kepada keluarga Kami.
Dengan memohon Rahmat dan Ridho Allah SWT, kami bermaksud mengundang Bapak/Ibu/Saudara/i untuk dapat menghadiri acara pernikahan kami:

*{{couple}}*

Berikut link undangan kami, untuk info selengkapnya dari acara silahkan kunjungi :
{{link}}

Tiada lain yang dapat kami ungkapkan, selain ucapan terima kasih yang tulus, atas kehadiran Bapak/Ibu/Saudara/i. Jazakumullahu Khairan Katsiran.
Sebelumnya kami memohon maaf membagikan kabar bahagia ini melalui pesan singkat, dikarenakan saat ini suasana masih dalam keadaan pandemi. Terima kasih banyak atas perhatiannya.
Wassalamualaikum warahmatullahi wabarakatuh.`,
         caption2: 
            `Kepada Yth.
Bapak/Ibu/Saudara/i
{{guest}}

Dengan tanpa mengurangi rasa hormat, perkenankan kami mengundang Bapak/Ibu/Saudara/i, untuk menghadiri acara pernikahan kami.

Berikut link untuk info lengkap dari acara kami :

{{link}}

Sungguh kami mengharap kehadiran Bapak/Ibu/Saudara/i sekalian untuk memberikan doa restu.

Terima kasih
*{{couple}}*`,
caption3:
`Assalamualaikum warahmatullahi wabarakatuh.

Dengan hormat, izinkan saya mengundang Bapak/Ibu/Saudara/i untuk menghadiri acara pernikahan kami:

*{{couple}}*

Untuk info selengkapnya dari acara, silahkan kunjungi link berikut ini :

{{link}}

Merupakan suatu kebahagiaan bagi kami apabila Bapak/Ibu/Saudara/i berkenan untuk hadir dan memberikan doa restu.

Wassalamualaikum warahmatullahi wabarakatuh.`,
caption4:
`Assalamualaikum warahmatullahi wabarakatuh.

Kepada teman-teman sekalian, sebelumnya kami meminta maaf karena mengabarkan berita bahagia hanya melalui pesan singkat.

Dengan ini kami mengajak kalian semua untuk datang ke acara pernikahan kami:

*{{couple}}*

Untuk info selengkapnya dari acara, silahkan kunjungi link berikut ini :

{{link}}

Semoga teman-teman semua bisa datang ke acara yang membahagiakan ini. Terima kasih banyak.

Wassalamualaikum warahmatullahi wabarakatuh.`,
caption5:
`Assalamualaikum warahmatullahi wabarakatuh.

Kepada teman-teman kerja dan pimpinan kantor, dengan pesan ini saya ingin mengundang Anda sekalian ke acara pernikahan saya:

*{{couple}}*

Berikut ini link undangan untuk info acara selengkapnya:

{{link}}

Saya harap teman-teman dan Bapak/Ibu pimpinan dapat menyempatkan diri hadir di acara tersebut. Terima kasih banyak atas waktu dan perhatian rekan-rekan sekalian.

Wassalamualaikum warahmatullahi wabarakatuh.`
         };
         
         
         function generateMessage() {
         const guest = $('#guestName').val();
         const tpl = $('#messageTemplate').val();

         const safeGuest = encodeURIComponent(guest);
         const inviteLink = `${coupleUrl}?to=${safeGuest}`;
         
         if (!guest || !tpl) return;
         
         
         let msg = templates[tpl]
         .replace('{{guest}}', guest)
         .replace('{{couple}}', coupleName)
         .replace('{{link}}', inviteLink);
         
         
         $('#messagePreview').val(msg);
         }
         
         
         $('#guestName, #messageTemplate').on('change keyup', generateMessage);
         
         
         $('#copyBtn').click(function () {
         $('#messagePreview').select();
         document.execCommand('copy');
         alert('Pesan berhasil disalin');
         });
         
         
         $('#waBtn').click(function () {
         const text = encodeURIComponent($('#messagePreview').val());
         if (!text) return alert('Pesan masih kosong');
         window.open(`https://wa.me/?text=${text}`, '_blank');
         });
      </script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

      <script type="module">
         /* =====================
            DOWNLOAD RSVP EXCEL
         ===================== */

         import { createClient } from
         'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

         /* ===== CONFIG ===== */
         const supabase = createClient(
         'https://klhjovidkfvjzshquhqt.supabase.co',
         'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsaGpvdmlka2Z2anpzaHF1aHF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MzQ2MzIsImV4cCI6MjA4MjExMDYzMn0.6OjoyeCjgtx6gXFsySGH68w9TGkyf1p0fvkKVRyjy5w'
         );

         const segments = window.location.pathname
         .split('/')
         .filter(Boolean);

         const groupName = segments[0] || 'default';

         $('#btnDownloadRsvp').on('click', async function () {

         const { data, error } = await supabase
            .from('Rsvp')
            .select('name, isattand, group, created_at')
            .eq('group', groupName)
            .order('created_at', { ascending: true });

         if (error) {
            alert('Gagal mengambil data RSVP');
            console.error(error);
            return;
         }

         if (!data || data.length === 0) {
            alert('Data RSVP masih kosong');
            return;
         }

         // Format data untuk Excel
         const formatted = data.map((item, index) => ({
            No: index + 1,
            Nama: item.name,
            Kehadiran: item.isattand ? 'Hadir' : 'Tidak Hadir',
            Waktu: new Date(item.created_at).toLocaleString('id-ID')
         }));

         // Buat worksheet & workbook
         const worksheet = XLSX.utils.json_to_sheet(formatted);
         const workbook = XLSX.utils.book_new();
         XLSX.utils.book_append_sheet(workbook, worksheet, 'RSVP');

         // Download file
         XLSX.writeFile(
            workbook,
            `RSVP-${groupName}-${new Date().toISOString().slice(0,10)}.xlsx`
         );
         });
      </script>
   </body>
</html>